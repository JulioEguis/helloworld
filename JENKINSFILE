pipeline {
    agent any

    stages {
        stage('Get Code') {
            steps {
                bat 'dir'
                echo WORKSPACE
            }
        }

        stage('Unit') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat 'set PYTHONPATH=. && pytest --junitxml=result-unit.xml test\\unit'
                }
                // Publicaci칩n inmediata
                junit 'result-unit.xml'
            }
        }

        stage('Rest') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set FLASK_APP=app\\api.py
                        start /B flask run
                        ping -n 5 127.0.0.1 > nul
                        pytest --junitxml=result-rest.xml test\\rest
                    '''
                }
                // Publicaci칩n inmediata 
                junit 'result-rest.xml'
            }
        }

        stage('Static') {
            steps {
                // An치lisis con Flake8 (Umbral: 8 inestable / 10 fallo)
                bat 'flake8 app --output-file=flake8-report.txt || exit 0'
                recordIssues tools: [flake8(pattern: 'flake8-report.txt')], 
                             qualityGates: [[threshold: 8, type: 'TOTAL', unstable: true], 
                                            [threshold: 10, type: 'TOTAL', unstable: false]]
            }
        }

        stage('Security Test') {
            steps {
                // An치lisis con Bandit (Umbral: 2 inestable / 4 fallo)
                bat 'bandit -r app -f xml -o bandit-report.xml || exit 0'
                recordIssues tools: [bandit(pattern: 'bandit-report.xml')], 
                             qualityGates: [[threshold: 2, type: 'TOTAL', unstable: true], 
                                            [threshold: 4, type: 'TOTAL', unstable: false]]
            }
        }

        stage('Performance') {
            steps {
                // Pruebas de carga.
                bat 'ab -n 100 -c 5 http://localhost:5000/sumar/1/1 > performance.txt'
                performanceReport reportFiles: 'performance.txt', configType: 'AB'
            }
        }

        stage('Coverage') {
            steps {
                script {
                    bat 'set PYTHONPATH=. && coverage run --source=app --omit=app/__init__.py,app/api.py -m pytest test/unit'
                    bat 'coverage xml -o coverage.xml'
                    cobertura autoUpdateHealth: false, 
                              autoUpdateStability: false, 
                              coberturaReportFile: 'coverage.xml', 
                              lineUnhealthy: 85, 
                              lineUnstable: 95
                }
            }
        }
    }
}

