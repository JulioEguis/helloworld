pipeline {
    agent any

    stages {
        stage('Get Code') {
            steps {
                bat 'dir'
                echo WORKSPACE
            }
        }

        stage('Unit') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat 'set PYTHONPATH=. && pytest --junitxml=result-unit.xml test\\unit'
                }
                junit 'result-unit.xml'
            }
        }

        stage('Rest') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set FLASK_APP=app\\api.py
                        start /B flask run
                        start java -jar C:\\UNIR\\Ejercicios\\wiremock\\wiremock-jre8-standalone-2.28.0.jar --port 9090 --root-dir C:\\UNIR\\Ejercicios\\wiremock
                        ping -n 10 127.0.0.1 > nul
                        pytest --junitxml=result-rest.xml test\\rest
                    '''
                }
                junit 'result-rest.xml'
            }
        }

        stage('Static') {
            steps {
                bat 'flake8 app --output-file=flake8-report.txt || exit 0'
                recordIssues tools: [flake8(pattern: 'flake8-report.txt')], 
                             qualityGates: [[threshold: 8, type: 'TOTAL', unstable: true]]
            }
        }

        stage('Security Test') {
            steps {
                bat 'bandit -r app -f xml -o bandit-report.xml || exit 0'
                recordIssues tools: [pyLint(pattern: 'bandit-report.xml', id: 'bandit', name: 'Bandit')]
            }
        }

        stage('Performance') {
            steps {
                bat 'ab -n 100 -c 5 http://localhost:5000/sumar/1/1 > performance.txt'
                performanceReport sourceDataFiles: 'performance.txt'
            }
        }

        stage('Coverage') {
            steps {
                script {
                    bat 'set PYTHONPATH=. && coverage run --source=app --omit=app/__init__.py,app/api.py -m pytest test/unit'
                    bat 'coverage xml -o coverage.xml'
                    cobertura autoUpdateHealth: false, 
                              autoUpdateStability: false, 
                              coberturaReportFile: 'coverage.xml', 
                              lineUnstable: 95
                }
            }
        }
    }
}
